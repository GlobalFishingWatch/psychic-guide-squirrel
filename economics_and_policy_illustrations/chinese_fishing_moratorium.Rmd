---
title: "Chinese_fishing_moratorium"
output:
  html_document: default
  html_notebook: default
---

```{r, echo=FALSE}
library(tidyverse)
library(bigrquery)
library(DBI)
library(lubridate)
library(dygraphs)

BQ_connection <-  dbConnect(dbi_driver(), dataset = "", project = "ucsb-gfw")
knitr::opts_chunk$set(connection = "BQ_connection", echo = FALSE, message = FALSE, warning = FALSE)
```

### Time series of active days

Lets take a look at the number of active Chinese vessels (more than 1 position with speed > 1) per day from 2013-2016.

```{sql, connection = BQ_connection, output.var = "chinese_active_vessels_all_years_sql", eval = FALSE}
SELECT
  eez,
  year,
  date(timestamp) date,
  exact_count_distinct(mmsi) active_vessels,
  sum(if(measure_new_score >= .5, hours, 0)) fishing_hours
FROM
  [ucsb-gfw:fao_v2.all_years_clean_effort]
WHERE
country == "China" and speed > .1 and year != 2012
  group by eez, year, date order by date
```

```{r}
chinese_active_vessels_all_years <- src_bigquery(project = "ucsb-gfw", 
                                         dataset = "fao_v2") %>%
  tbl("all_years_clean_effort") %>%
  filter(country == "China", speed > .1, year != 2012) %>% 
  mutate(date = date(timestamp)) %>%
  group_by(eez, year, date) %>%
  summarise(active_vessels = exact_count_distinct(mmsi),
            fishing_hours = sum(ifelse(measure_new_score >= 0.5, hours, 0))) %>% 
  ungroup() %>% 
  collect()


all_other_active_vessels_all_years <- src_bigquery(project = "ucsb-gfw", 
                                         dataset = "fao_v2") %>%
  tbl("all_years_clean_effort") %>%
  filter(country != "China", speed > .1, year != 2012) %>% 
  mutate(date = date(timestamp)) %>%
  group_by(year, date) %>%
  summarise(active_vessels = exact_count_distinct(mmsi),
            fishing_hours = sum(ifelse(measure_new_score >= 0.5, hours, 0))) %>% 
  ungroup() %>% 
  collect()
```


```{r}
moratoria_dates <- tibble(year = c(2013:2016)) %>% 
  mutate(start_date = lubridate::ymd(paste(year,"-05-16",sep = "")),
         end_date = lubridate::ymd(paste(year,"-08-01",sep = "")))

new_year_dates <- tibble(year = c(2013:2016),
                         start_date = c(lubridate::ymd("2013-02-10"),
                                        lubridate::ymd("2014-01-31"),
                                        lubridate::ymd("2015-02-18"),
                                        lubridate::ymd("2016-02-07")),
                         end_date = c(lubridate::ymd("2013-02-15"),
                                      lubridate::ymd("2014-02-6"),
                                      lubridate::ymd("2015-02-24"),
                                      lubridate::ymd("2016-02-13")))

chinese_active_vessels_inside_eez <- chinese_active_vessels_all_years %>% 
  filter(eez == "China") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(year, date) %>% 
  summarise(active_vessels = sum(active_vessels),
            fishing_hours = sum(fishing_hours)) %>% 
  ungroup() %>% 
  dplyr::select(-year)


chinese_moratoria_plot_active_vessels <- 
  ggplot() +
  geom_rect(data = moratoria_dates, 
            aes(xmin = start_date, 
                xmax = end_date,
                ymin = 0,
                ymax = Inf),
             fill = "red", alpha = 0.5) +
  geom_rect(data = new_year_dates, 
            aes(xmin = start_date, 
                xmax = end_date,
                ymin = 0,
                ymax = Inf),
             fill = "lightblue", alpha = 0.8) +
  #geom_point(data = active_vessels_inside_eez,
           #aes(x = date, y = active_vessels), size = .3)+
  geom_line(data = chinese_active_vessels_inside_eez,
           aes(x = date, y = active_vessels), size = 0.3) +
  # geom_line(data = all_other_active_vessels_all_years,
  #          aes(x = lubridate::ymd(date), y = active_vessels), size = 0.3, color = "blue") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 75, hjust = 1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  scale_x_date(date_breaks = "1 month", date_labels = "%y %b", limits = c(min(chinese_active_vessels_inside_eez$date),max(chinese_active_vessels_inside_eez$date))) +
  xlab("") +
  scale_y_continuous(breaks = c(2000,4000,6000,8000,10000, 12000, 14000),expand = c(0, 0), labels = scales::comma, limits = c(0,16000) ) +
  ylab("Active vessels")

tiff(filename = "final_figures/chinese_moratoria_plot_active_vessels.tiff", height = 12, width = 20, units = 'cm', 
     compression = "lzw", res = 300)
chinese_moratoria_plot_active_vessels
dev.off()

```

```{r }
chinese_moratoria_plot_fishing_hours <- 
  ggplot() +
  geom_rect(data = moratoria_dates, 
            aes(xmin = start_date, 
                xmax = end_date,
                ymin = 0,
                ymax = Inf),
             fill = "red", alpha = 0.5) +
  geom_rect(data = new_year_dates, 
            aes(xmin = start_date, 
                xmax = end_date,
                ymin = 0,
                ymax = Inf),
             fill = "lightblue", alpha = 0.8) +
  #geom_point(data = active_vessels_inside_eez,
           #aes(x = date, y = active_vessels), size = .3)+
  geom_line(data = chinese_active_vessels_inside_eez,
           aes(x = date, y = fishing_hours), size = 0.3) +
  # geom_line(data = all_other_active_vessels_all_years,
  #        aes(x = lubridate::ymd(date), y = fishing_hours), size = 0.3, color = "blue") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 75, hjust = 1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  scale_x_date(date_breaks = "1 month", date_labels = "%y %b", limits = c(min(chinese_active_vessels_inside_eez$date),max(chinese_active_vessels_inside_eez$date))) +
  xlab("") +
  scale_y_continuous(breaks = c(20000,40000,60000,80000,100000, 120000),expand = c(0, 0), labels = scales::comma, limits = c(0,130000) ) +
  ylab("Fishing hours")

tiff(filename = "final_figures/chinese_moratoria_plot_hours.tiff", height = 12, width = 20, units = 'cm', 
     compression = "lzw", res = 300)
chinese_moratoria_plot_fishing_hours
dev.off()
```


```{r , fig.width=12}
dygraphs::dygraph(xts::xts(chinese_active_vessels_inside_eez$active_vessels, chinese_active_vessels_inside_eez$date),  
                  main = "Active Chinese vessels inside their own EEZ") %>% 
  dygraphs::dyRangeSelector(dateWindow = c("2013-01-01", "2016-12-31")) %>% 
  dySeries(label = "Active vessels", color = "black") %>%
  dyShading(from = "2016-02-07", to = "2016-02-13", color = "#CCEBD6") %>% 
  dyShading(from = "2015-02-18", to = "2015-02-24", color = "#CCEBD6") %>% 
  dyShading(from = "2014-01-31", to = "2014-02-6", color = "#CCEBD6") %>% 
  dyShading(from = "2013-02-10", to = "2013-02-15", color = "#CCEBD6") %>% 
  dyShading(from = "2016-05-16", to = "2016-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2015-05-16", to = "2015-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2014-05-16", to = "2014-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2013-05-16", to = "2013-08-01", color = "#FFE6E6") %>% 
  dyRoller(rollPeriod = 3)
```

### Does the number of active vessels increase in other regions because of the moratoria?

```{r, fig.width=12}
t <- chinese_active_vessels_all_years %>%
  mutate(eez = stringi::stri_unescape_unicode(eez)) %>% # removes the weird "\" is the eez names for conflict zones
  filter(eez == paste("Conflict zone China/Japan/Taiwan")) %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(year, date) %>% 
  summarise(active_vessels = sum(active_vessels)) %>% 
  ungroup() %>% 
  select(-year)

dygraphs::dygraph(xts::xts(t$active_vessels,t$date), main = "Active Chinese vessels in Conflict zone China/Japan/Taiwan") %>% 
  dygraphs::dyRangeSelector(dateWindow = c("2013-01-01", "2016-12-31")) %>% 
  dySeries(label = "Active vessels", color = "black") %>%
  dyShading(from = "2016-05-16", to = "2016-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2015-05-16", to = "2015-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2014-05-16", to = "2014-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2013-05-16", to = "2013-08-01", color = "#FFE6E6") 
```

```{r, fig.width=12}
t <- chinese_active_vessels_all_years %>% 
  filter(eez == "South Korea") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(year, date) %>% 
  summarise(active_vessels = sum(active_vessels)) %>% 
  ungroup() %>% 
  select(-year)

dygraphs::dygraph(xts::xts(t$active_vessels,t$date), main = "Active Chinese vessels in South Korea EEZ") %>% 
  dygraphs::dyRangeSelector(dateWindow = c("2013-01-01", "2016-12-31")) %>% 
  dySeries(label = "Active vessels", color = "black") %>%
  dyShading(from = "2015-05-16", to = "2015-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2014-05-16", to = "2014-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2013-05-16", to = "2013-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2016-05-16", to = "2016-08-01", color = "#FFE6E6")
```

```{r, fig.width=12}
t <- chinese_active_vessels_all_years %>% 
  filter(is.na(eez)) %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(year, date) %>% 
  summarise(active_vessels = sum(active_vessels)) %>% 
  ungroup() %>% 
  select(-year)

dygraphs::dygraph(xts::xts(t$active_vessels,t$date), main = "Active Chinese vessels in the high seas") %>% 
  dygraphs::dyRangeSelector(dateWindow = c("2013-01-01", "2016-12-31")) %>% 
  dySeries(label = "Active vessels", color = "black") %>%
  dyShading(from = "2016-05-16", to = "2016-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2015-05-16", to = "2015-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2014-05-16", to = "2014-08-01", color = "#FFE6E6") %>% 
  dyShading(from = "2013-05-16", to = "2013-08-01", color = "#FFE6E6") 
```

### How many vessels are affected by the moratoria?

Comparing vessel activity in China's EEZ one month before and after the moratoria with vessel activity during the moratoria we can estimate the number of vessels **affected** by this policy:

```{sql connection = BQ_connection, output.var = "affected_vessels_2016", eval = FALSE}
SELECT
  mmsi,
FROM
  [fao_v2.all_years_clean_effort]
WHERE
  country == "China" and eez == "China"
  and speed > .1
  AND (
  (DATE(timestamp) < "2016-05-16" AND DATE(timestamp) > "2016-04-16") or (DATE(timestamp) > "2016-08-01" AND DATE(timestamp) < "2016-09-01")
  )
  AND mmsi NOT IN (
  SELECT
    mmsi
  FROM
    [fao_v2.all_years_clean_effort]
  WHERE
    country == "China" and speed > .1 and eez == "China"
    AND (
    (DATE(timestamp) > "2016-05-16" AND DATE(timestamp) < "2016-08-01") 
    )
  GROUP BY
    mmsi)
    group by mmsi
```

We can estimate that `r n_distinct(affected_vessels$mmsi)` vessels were affected by the moratoria in 2016.

```{sql connection = BQ_connection, output.var = "removed_vessels_2016"}
SELECT
  mmsi,
FROM
  [fao_v2.all_years_clean_effort]
WHERE
  country == "China" and eez == "China"
  and speed > .1
  AND (
  (DATE(timestamp) < "2016-05-16" AND DATE(timestamp) > "2016-04-16") or (DATE(timestamp) > "2016-08-01" AND DATE(timestamp) < "2016-09-01")
  )
  AND mmsi NOT IN (
  SELECT
    mmsi
  FROM
    [fao_v2.all_years_clean_effort]
  WHERE
    country == "China" and speed > .1 
    AND (
    (DATE(timestamp) > "2016-05-16" AND DATE(timestamp) < "2016-08-01") 
    )
  GROUP BY
    mmsi)
    group by mmsi
```

```{r}
displaced_vessels_2016 <- affected_vessels_2016 %>%
  filter(!mmsi %in% removed_vessels_2016$mmsi) 
```


```{r}
BQ_connection <-  dbConnect(dbi_driver(), dataset = "Juan", project = "ucsb-gfw")

if(dbExistsTable(BQ_connection, "chinese_moratorium_displaced_vessels_2016")){
  dbRemoveTable(BQ_connection, "chinese_moratorium_displaced_vessels_2016") 
  dbWriteTable(BQ_connection, "chinese_moratorium_displaced_vessels_2016", displaced_vessels_2016)
} else {dbWriteTable(BQ_connection, "chinese_moratorium_displaced_vessels_2016", displaced_vessels_2016)}
```

Of these `r n_distinct(affected_vessels$mmsi)` vessels, `r n_distinct(removed_vessels$mmsi)` are not seen **at all** during the moratoria and `r n_distinct(displaced_vessels$mmsi)` displaced their effort outside of China's EEZ. 

**The question then is: what are these vessels doing? where did they go?** 

```{sql connection = BQ_connection, output.var = "displaced_effort_2016"}
SELECT
  year,
  eez,
  date(timestamp) date,
  exact_count_distinct(mmsi) active_vessels,
  sum(if(measure_new_score >= .5, hours, 0)) fishing_hours
FROM
  [ucsb-gfw:fao_v2.all_years_clean_effort]
WHERE
country == "China" and speed > .1 and year = 2016 and mmsi in (Select mmsi from [Juan.chinese_moratorium_displaced_vessels_2016])
  group by year, eez, date order by date
```

```{r}
effort_inside <- displaced_effort_2016 %>% 
  filter(eez == "China") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(date) %>% 
  summarise(fishing_hours = sum(fishing_hours)) %>% 
  ungroup()
    
effort_inside <- xts::xts(effort_inside$fishing_hours,effort_inside$date)

effort_outside <- displaced_effort_2016 %>% 
  filter(!is.na(eez) & eez != "China") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(date) %>% 
  summarise(fishing_hours = sum(fishing_hours)) %>% 
  ungroup() 

effort_outside <- xts::xts(effort_outside$fishing_hours,effort_outside$date)

effort <- cbind(effort_outside,effort_inside)

dygraphs::dygraph(effort, main = "Fishing hours by the displaced fleet before, during, and after moratoria") %>% 
  dygraphs::dyRangeSelector(dateWindow = c("2016-01-01", "2016-12-31")) %>% 
  dySeries(name = "..1",label = "Effort in foreign EEZ", color = "blue") %>%
  dySeries(name = "..2",label = "Effort inside EEZ", color = "black") %>%
  dyShading(from = "2016-05-16", to = "2016-08-01", color = "#FFE6E6") %>% 
  dyLegend(width = 500) %>% 
  dyRoller(rollPeriod = 3)
```


#### Same Analysis using dplyr and birgquery

```{r}
active_vessels_during_moratoria <- src_bigquery(project = "ucsb-gfw",dataset = "fao_v2") %>% 
  tbl("all_years_clean_effort") %>% 
  filter(country == "China", 
         speed > .1,
         (date(timestamp) > "2015-05-16" && date(timestamp) < "2015-08-01")) %>% 
  distinct(mmsi) %>% 
  collect()

active_vessels_inside_EEZ_during_moratoria <- src_bigquery(project = "ucsb-gfw",dataset = "fao_v2") %>% 
  tbl("all_years_clean_effort") %>% 
  filter(country == "China", 
         eez == "China",
         speed > .1,
         (date(timestamp) > "2015-05-16" && date(timestamp) < "2015-08-01")) %>% 
  distinct(mmsi) %>% 
  collect()

active_vessels_before_and_after_moratoria <- src_bigquery(project = "ucsb-gfw",dataset = "fao_v2") %>% 
  tbl("all_years_clean_effort") %>% 
  filter(country == "China", 
         eez == "China",
         speed > .1,
         ((date(timestamp) > "2015-04-16" && date(timestamp) < "2015-05-16") |  (date(timestamp) > "2015-08-01" && date(timestamp) < "2015-09-01"))) %>%
  distinct(mmsi) %>% 
  collect()

affected_vessels <- active_vessels_before_and_after_moratoria %>% 
  filter(!mmsi %in% active_vessels_inside_EEZ_during_moratoria$mmsi) %>% 
  distinct(mmsi) %>% 
  collect()

removed_vessels <- active_vessels_before_and_after_moratoria %>% 
  filter(!mmsi %in% active_vessels_during_moratoria$mmsi) %>% 
  distinct(mmsi) 

displaced_vessels <- affected_vessels %>%
  filter(!mmsi %in% removed_vessels$mmsi) 
```

```{r}
displaced_effort <- src_bigquery(project = "ucsb-gfw",dataset = "fao_v2") %>% 
  tbl("all_years_clean_effort") %>% 
  filter(country == "China",
         speed > .1,
         year == 2015,
         mmsi %in% displaced_vessels$mmsi) %>% 
  mutate(date = date(timestamp)) %>% 
  group_by(year, eez, date) %>% 
  summarize(active_vessels = n_distinct(mmsi),
            fishing_hours = sum(ifelse(measure_new_score >= 0.5, hours, 0))) %>% 
  ungroup() %>% 
  collect()
```

```{r}
effort_inside <- displaced_effort %>% 
  filter(eez == "China") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(date) %>% 
  summarise(fishing_hours = sum(fishing_hours)) %>% 
  ungroup() 

effort_inside <- xts::xts(effort_inside$fishing_hours,effort_inside$date)

effort_outside <- displaced_effort %>% 
  filter(!is.na(eez) & eez != "China") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(date) %>% 
  summarise(fishing_hours = sum(fishing_hours)) %>% 
  ungroup() 

effort_outside <- xts::xts(effort_outside$fishing_hours,effort_outside$date)

effort <- cbind(effort_outside,effort_inside)

dygraphs::dygraph(effort, main = "Fishing hours by the displaced fleet before, during, and after moratoria") %>% 
  dygraphs::dyRangeSelector(dateWindow = c("2015-01-01", "2015-12-31")) %>% 
  dySeries(name = "..1",label = "Effort in foreign EEZ", color = "blue") %>%
  dySeries(name = "..2",label = "Effort inside EEZ", color = "black") %>%
  dyShading(from = "2015-05-16", to = "2015-08-01", color = "#FFE6E6") %>% 
  dyLegend(width = 500) %>% 
  dyRoller(rollPeriod = 3)
```

#### Can I do it for all years?

<!-- ```{sql, connection = BQ_connection, output.var = "all_affected_vessels"} -->
<!-- Select -->
<!-- year, -->
<!-- mmsi -->
<!-- from -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2016-05-16" AND DATE(timestamp) > "2016-04-16") or (DATE(timestamp) > "2016-08-01" AND DATE(timestamp) < "2016-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1 and eez == "China" -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2016-05-16" AND DATE(timestamp) < "2016-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi), -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2015-05-16" AND DATE(timestamp) > "2015-04-16") or (DATE(timestamp) > "2015-08-01" AND DATE(timestamp) < "2015-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1 and eez == "China" -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2015-05-16" AND DATE(timestamp) < "2015-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi), -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2014-05-16" AND DATE(timestamp) > "2014-04-16") or (DATE(timestamp) > "2014-08-01" AND DATE(timestamp) < "2014-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1 and eez == "China" -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2014-05-16" AND DATE(timestamp) < "2014-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi), -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2013-05-16" AND DATE(timestamp) > "2013-04-16") or (DATE(timestamp) > "2013-08-01" AND DATE(timestamp) < "2013-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1 and eez == "China" -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2013-05-16" AND DATE(timestamp) < "2013-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi) -->
<!-- ``` -->

<!-- ```{sql, connection = BQ_connection, output.var = "all_removed_vessels"} -->
<!-- Select -->
<!-- year, -->
<!-- mmsi -->
<!-- from -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2016-05-16" AND DATE(timestamp) > "2016-04-16") or (DATE(timestamp) > "2016-08-01" AND DATE(timestamp) < "2016-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1  -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2016-05-16" AND DATE(timestamp) < "2016-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi), -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2015-05-16" AND DATE(timestamp) > "2015-04-16") or (DATE(timestamp) > "2015-08-01" AND DATE(timestamp) < "2015-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1  -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2015-05-16" AND DATE(timestamp) < "2015-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi), -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2014-05-16" AND DATE(timestamp) > "2014-04-16") or (DATE(timestamp) > "2014-08-01" AND DATE(timestamp) < "2014-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1  -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2014-05-16" AND DATE(timestamp) < "2014-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi), -->
<!-- (SELECT -->
<!--   year,  -->
<!--   mmsi, -->
<!-- FROM -->
<!--   [fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!--   country == "China" and eez == "China" -->
<!--   and speed > 1 -->
<!--   AND ( -->
<!--   (DATE(timestamp) < "2013-05-16" AND DATE(timestamp) > "2013-04-16") or (DATE(timestamp) > "2013-08-01" AND DATE(timestamp) < "2013-09-01") -->
<!--   ) -->
<!--   AND mmsi NOT IN ( -->
<!--   SELECT -->
<!--     mmsi -->
<!--   FROM -->
<!--     [fao_v2.all_years_clean_effort] -->
<!--   WHERE -->
<!--     country == "China" and speed > 1  -->
<!--     AND ( -->
<!--     (DATE(timestamp) > "2013-05-16" AND DATE(timestamp) < "2013-08-01")  -->
<!--     ) -->
<!--   GROUP BY -->
<!--     mmsi) -->
<!--     group by year, mmsi) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- all_displaced_vessels <- all_affected_vessels %>% -->
<!--   #group_by(year) %>% -->
<!--   anti_join(all_removed_vessels, by = c("year","mmsi")) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- all_displaced_vessels %>% filter(year == 2016) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- BQ_connection <-  dbConnect(dbi_driver(), dataset = "Juan", project = "ucsb-gfw") -->

<!-- if(dbExistsTable(BQ_connection, "chinese_moratorium_all_displaced_vessels")){ -->
<!--   dbRemoveTable(BQ_connection, "chinese_moratorium_all_displaced_vessels")  -->
<!--   dbWriteTable(BQ_connection, "chinese_moratorium_all_displaced_vessels", all_displaced_vessels) -->
<!-- } else {dbWriteTable(BQ_connection, "chinese_moratorium_all_displaced_vessels", all_displaced_vessels)} -->
<!-- ``` -->

<!-- ```{sql  connection = BQ_connection, output.var = "all_displaced_effort"} -->
<!-- Select  -->
<!-- *  -->
<!-- from -->
<!-- (SELECT -->
<!--   year, -->
<!--   eez, -->
<!--   date(timestamp) date, -->
<!--   exact_count_distinct(mmsi) active_vessels, -->
<!--   sum(if(measure_new_score >= .5, hours, 0)) fishing_hours -->
<!-- FROM -->
<!--   [ucsb-gfw:fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!-- country == "China" and speed > .1 and year = 2016 and mmsi in (Select mmsi from [Juan.chinese_moratorium_all_displaced_vessels] where year = 2016) -->
<!--   group by year, eez, date order by date), -->
<!-- (SELECT -->
<!--   year, -->
<!--   eez, -->
<!--   date(timestamp) date, -->
<!--   exact_count_distinct(mmsi) active_vessels, -->
<!--   sum(if(measure_new_score >= .5, hours, 0)) fishing_hours -->
<!-- FROM -->
<!--   [ucsb-gfw:fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!-- country == "China" and speed > .1 and year = 2015 and mmsi in (Select mmsi from [Juan.chinese_moratorium_all_displaced_vessels] where year = 2015) -->
<!--   group by year, eez, date order by date), -->
<!-- (SELECT -->
<!--   year, -->
<!--   eez, -->
<!--   date(timestamp) date, -->
<!--   exact_count_distinct(mmsi) active_vessels, -->
<!--   sum(if(measure_new_score >= .5, hours, 0)) fishing_hours -->
<!-- FROM -->
<!--   [ucsb-gfw:fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!-- country == "China" and speed > .1 and year = 2014 and mmsi in (Select mmsi from [Juan.chinese_moratorium_all_displaced_vessels] where year = 2014) -->
<!--   group by year, eez, date order by date), -->
<!--   (SELECT -->
<!--   year, -->
<!--   eez, -->
<!--   date(timestamp) date, -->
<!--   exact_count_distinct(mmsi) active_vessels, -->
<!--   sum(if(measure_new_score >= .5, hours, 0)) fishing_hours -->
<!-- FROM -->
<!--   [ucsb-gfw:fao_v2.all_years_clean_effort] -->
<!-- WHERE -->
<!-- country == "China" and speed > .1 and year = 2013 and mmsi in (Select mmsi from [Juan.chinese_moratorium_all_displaced_vessels] where year = 2013) -->
<!--   group by year, eez, date order by date) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- effort_inside <- all_displaced_effort %>%  -->
<!--   filter(eez == "China") %>%  -->
<!--   mutate(date = lubridate::ymd(date)) %>%  -->
<!--   group_by(date) %>%  -->
<!--   summarise(fishing_hours = sum(fishing_hours)) %>%  -->
<!--   ungroup()  -->

<!-- effort_inside <- xts::xts(effort_inside$fishing_hours,effort_inside$date) -->

<!-- effort_outside <- all_displaced_effort %>%  -->
<!--   filter(!is.na(eez) & eez != "China") %>%  -->
<!--   mutate(date = lubridate::ymd(date)) %>%  -->
<!--   group_by(date) %>%  -->
<!--   summarise(fishing_hours = sum(fishing_hours)) %>%  -->
<!--   ungroup()  -->

<!-- effort_outside <- xts::xts(effort_outside$fishing_hours,effort_outside$date) -->

<!-- effort <- cbind(effort_outside,effort_inside) -->

<!-- dygraphs::dygraph(effort, main = "Fishing hours by the displaced fleet before, during, and after moratoria") %>%  -->
<!--   dygraphs::dyRangeSelector(dateWindow = c("2013-01-01", "2016-12-31")) %>%  -->
<!--   dySeries(name = "..1",label = "Effort in foreign EEZ", color = "blue") %>% -->
<!--   dySeries(name = "..2",label = "Effort inside EEZ", color = "black") %>% -->
<!--   dyShading(from = "2013-05-16", to = "2013-08-01", color = "#FFE6E6") %>%  -->
<!--   dyShading(from = "2014-05-16", to = "2014-08-01", color = "#FFE6E6") %>%  -->
<!--   dyShading(from = "2015-05-16", to = "2015-08-01", color = "#FFE6E6") %>%  -->
<!--   dyShading(from = "2016-05-16", to = "2016-08-01", color = "#FFE6E6") %>%  -->
<!--   dyLegend(width = 500) %>%  -->
<!--   dyRoller(rollPeriod = 3) -->
<!-- ``` -->


# What happens the moratoria ends? ANIMATION

```{r}
removed_vessels_2015 <-  as.integer(removed_vessels$mmsi)

removed_vessels_effort_2015 <- src_bigquery(project = "ucsb-gfw", dataset = "fao_v2") %>% 
  tbl("all_years_clean_effort") %>% 
  filter(country == "China", 
         eez == "China", 
         year == 2015, 
         speed > .1, 
         mmsi %in% removed_vessels_2015,
         date(timestamp) > "2015-07-26",
         date(timestamp) < "2015-08-03") %>%
  select(mmsi, timestamp,lon,lat) %>% 
  collect()
  
removed_vessels_effort_2015 <- removed_vessels_effort_2015 %>% 
               mutate(dh = round_date(timestamp, unit = "hours")) %>% 
  arrange(dh)

p <- ggmap::ggmap(ggmap::get_map(location = c(120,30,120,30), zoom = 5,  maptype = c("satellite"), source = 'google'))+
  geom_point(data = removed_vessels_effort_2015,
             aes(x=lon, y=lat, frame = dh), color="red", size = 1)

gganimate::gg_animate(p, interval = .2)
gganimate::gg_animate(p, interval = .2, "China_2015.mp4")
```

```{sql connection = BQ_connection, output.var = "removed_vessels_effort_2015"}
select
mmsi,
timestamp,
lon,
lat
FROM
  [fao_v2.all_years_clean_effort]
WHERE
country == "China" and eez == "China" and year = 2015 and speed > 1 and mmsi in (
SELECT
  mmsi
FROM
  [fao_v2.2015_clean_effort]
WHERE
  country == "China" and eez == "China"
  and speed > 1
  AND ((DATE(timestamp) < "2015-05-16" AND DATE(timestamp) > "2015-04-16") or (DATE(timestamp) > "2015-08-01" AND DATE(timestamp) < "2015-09-01")) 
  AND mmsi NOT IN (
  SELECT
    mmsi
  FROM
    [fao_v2.2015_clean_effort]
  WHERE
    country == "China" and speed > 1 
    AND DATE(timestamp) > "2015-05-16"
    AND DATE(timestamp) < "2015-08-01"
  GROUP BY
    mmsi)
    group by mmsi) 
  AND DATE(timestamp) > "2015-07-26"
    AND DATE(timestamp) < "2015-08-02"
```

```{r, fig.show='animate'}
removed_vessels_effort_2015 <- removed_vessels_effort_2015 %>% 
               mutate(dh = round_date(timestamp, unit = "hours")) %>% 
  arrange(dh)

p <- ggmap::ggmap(ggmap::get_map(location = c(120,30,120,30), zoom = 5,  maptype = c("satellite"), source = 'google'))+
  geom_point(data = removed_vessels_effort_2015,
             aes(x=lon, y=lat, frame = dh), color="red", size = 1)

gganimate::gg_animate(p, interval = .2)
gganimate::gg_animate(p, interval = .2, "China_2015.mp4")
```


```{r, eval=FALSE}
# removed_vessels_effort_2015 <- removed_vessels_effort_2015 %>% 
#                mutate(dh = round_date(timestamp, unit = "hours")) %>% 
#   arrange(dh)
# 
# day_hours <- unique(removed_vessels_effort_2015$dh)
# 
# for (i in seq_along(day_hours)){
#   p <- ggmap::ggmap(ggmap::get_map(location = c(125,30,125,30), zoom = 4,  maptype = c("satellite"), source = 'google'))+
#   geom_point(data = removed_vessels_effort_2015 %>% 
#                filter(dh == day_hours[i]),
#              aes(x=lon, y=lat), color="red", size = 1)
#   ggsave(filename = paste("chinese_blub/plot_",day_hours[i],".pdf",sep = ""), p, device = "pdf")
# }

```

```{r fig.show='animate', eval=FALSE}
#Generate a dggs specifying an intercell spacing of ~25 miles
dggs <- dgconstruct(spacing=25, metric=FALSE, resround='nearest')

#Get the corresponding grid cells for each  (lat-long pair)
removed_vessels_effort_2015$cell <- dgtransform(dggs,removed_vessels_effort_2015$lat,removed_vessels_effort_2015$lon)

#Get the sum of effort in each cell
point_counts   <- removed_vessels_effort_2015 %>% 
  mutate(dh = round_date(timestamp, unit = "hours")) %>% 
  group_by(dh,cell) %>% 
  summarise(counts=n())

#Get the grid cell boundaries for cells with effort
grid <- dgcellstogrid(dggs,point_counts$cell,frame=TRUE,wrapcells=TRUE)
                                                                
#Update the grid cells' properties to include the effort in each cell
grid <- merge(grid,point_counts,by.x="Name",by.y="cell")
grid$counts    <- log(grid$counts)

p <- ggmap::ggmap(ggmap::get_map(location = c(120,30,120,30), zoom = 5,  maptype = c("satellite"), source = 'google'))+
  geom_polygon(data=grid, aes(x=long, y=lat, group=group, fill=counts, frame = dh), alpha=0.6)    +
    geom_path   (data=grid,      aes(x=long, y=lat, group=group), alpha=0.4, color="white") +
    scale_fill_gradient(low="yellow", high="red")+
  theme_minimal()
p
gganimate::gg_animate(p, interval = .3)

```


### Who is NOT affected by the moratoria?
```{r eval = FALSE}
BQ_connection <-  dbConnect(dbi_driver(), dataset = "", project = "high-seas")
```

```{sql connection = BQ_connection, output.var = "NOT_affected_vessels", eval = FALSE}
SELECT
    mmsi,
    sum(if ((eez is null or eez == "Antarctica") and measure_new_score >= 0.5, hours,0)) fishing_hours_in_HS,
    sum(if (eez == "China" and measure_new_score >= 0.5, hours,0)) fishing_hours_in_China,
    sum(if (eez != "China" and eez != "Antarctica" and eez is not null and measure_new_score >= 0.5, hours,0)) fishing_hours_in_foreign_EEZ
  FROM
    [fao_v2.2015_clean_effort]
  WHERE
    country == "China" and speed > 1 and eez == "China"
    AND (
    (DATE(timestamp) > "2015-05-16" AND DATE(timestamp) < "2015-08-01")
    )
  GROUP BY
   mmsi
```

```{r, eval = FALSE}
NOT_affected_vessels %>% 
  ungroup() %>% 
  n_distinct("mmsi")

NOT_affected_vessels_2015 %>% 
  ggplot(aes(x = length)) +
  geom_histogram(
  aes(y = ..density..),
  # Histogram with density instead of count on y-axis
  binwidth = 5,
  colour = "black",
  fill = "white"
  ) +
  geom_density(alpha = .2, fill = "lightblue") +
  ggtitle('Size Distribution of unaffected vessels') +
  theme_bw()

#There are `r n_distinct(NOT_affected_vessels$mmsi)` vessels that remain active inside China's EEZ during the moratoria. Their size distribution looks like:
```

```{r eval = FALSE}
NOT_affected_vessels_2015 %>% 
  group_by(general_vessel_type) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  knitr::kable()
```
